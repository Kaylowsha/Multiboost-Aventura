<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiBoost - Modo Aventura</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">

    <!-- PANTALLA DE LOGIN/REGISTRO -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-3xl p-8 text-center max-w-md w-full">
            
            <!-- HEADER -->
            <h1 class="text-4xl font-bold mb-2">‚ö° MultiBoost ‚ö°</h1>
            <h2 class="text-2xl mb-2 text-yellow-300">üèÉ‚Äç‚ôÇÔ∏è MODO AVENTURA</h2>
            <p class="text-lg mb-8 opacity-90">Registra tu progreso y mejora d√≠a a d√≠a</p>

            <!-- PESTA√ëAS -->
            <div class="flex mb-6">
                <button onclick="showLogin()" id="login-tab" class="flex-1 py-3 px-4 rounded-l-xl bg-white bg-opacity-30 font-bold">
                    Iniciar Sesi√≥n
                </button>
                <button onclick="showRegister()" id="register-tab" class="flex-1 py-3 px-4 rounded-r-xl bg-white bg-opacity-10 font-bold">
                    Registrarse
                </button>
            </div>

            <!-- FORMULARIO LOGIN -->
            <div id="login-form" class="space-y-4">
                <h3 class="text-xl font-bold mb-4">Bienvenido de vuelta</h3>
                
                <input type="email" id="login-email" placeholder="Tu email" 
                       class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                
                <input type="password" id="login-password" placeholder="Tu contrase√±a" 
                       class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                
                <button onclick="loginUser()" id="login-btn" 
                        class="w-full py-4 px-6 rounded-2xl text-xl font-bold text-white shadow-lg bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600">
                    üöÄ Entrar a Mi Aventura
                </button>
            </div>

            <!-- FORMULARIO REGISTRO -->
            <div id="register-form" class="space-y-4" style="display: none;">
                <h3 class="text-xl font-bold mb-4">Comienza tu aventura</h3>
                
                <input type="text" id="register-name" placeholder="Tu nombre" 
                       class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                
                <input type="email" id="register-email" placeholder="Tu email" 
                       class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                
                <input type="password" id="register-password" placeholder="Crea una contrase√±a" 
                       class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                
                <button onclick="registerUser()" id="register-btn"
                        class="w-full py-4 px-6 rounded-2xl text-xl font-bold text-white shadow-lg bg-gradient-to-r from-purple-400 to-pink-500 hover:from-purple-500 hover:to-pink-600">
                    ‚ú® Crear Mi Aventura
                </button>
            </div>

            <!-- MENSAJES -->
            <div id="message" class="mt-4 p-3 rounded-lg" style="display: none;"></div>

            <!-- BOT√ìN VOLVER -->
            <button onclick="goToHome()" class="w-full mt-6 py-3 px-6 rounded-2xl text-lg font-bold text-white bg-white bg-opacity-20 hover:bg-opacity-30">
                üè† ‚Üê Volver al Inicio
            </button>

        </div>
    </div>

    <!-- FIREBASE Y SCRIPTS -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Hacer disponibles globalmente
        window.auth = auth;
        window.db = db;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        console.log('üî• Modo Aventura cargado correctamente');
    </script>

    <script>
        // Cambiar entre pesta√±as
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-tab').classList.add('bg-white', 'bg-opacity-30');
            document.getElementById('login-tab').classList.remove('bg-opacity-10');
            document.getElementById('register-tab').classList.add('bg-opacity-10');
            document.getElementById('register-tab').classList.remove('bg-white', 'bg-opacity-30');
            hideMessage();
        }

        function showRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('register-tab').classList.add('bg-white', 'bg-opacity-30');
            document.getElementById('register-tab').classList.remove('bg-opacity-10');
            document.getElementById('login-tab').classList.add('bg-opacity-10');
            document.getElementById('login-tab').classList.remove('bg-white', 'bg-opacity-30');
            hideMessage();
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (type === 'success') {
                messageEl.className = 'mt-4 p-3 rounded-lg bg-green-500 bg-opacity-80 text-white font-bold';
            } else {
                messageEl.className = 'mt-4 p-3 rounded-lg bg-red-500 bg-opacity-80 text-white font-bold';
            }
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        // Generar c√≥digo √∫nico de estudiante
        function generateStudentCode() {
            const prefix = 'EST_';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = prefix;
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Registrar usuario
        async function registerUser() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            if (!name || !email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            document.getElementById('register-btn').disabled = true;
            document.getElementById('register-btn').textContent = 'Creando cuenta...';

            try {
                // Crear usuario en Firebase Auth
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                // Generar c√≥digo √∫nico
                const studentCode = generateStudentCode();

                // Crear perfil en Firestore
                await window.setDoc(window.doc(window.db, 'students', user.uid), {
                    name: name,
                    email: email,
                    studentCode: studentCode,
                    createdAt: new Date().toISOString(),
                    parentId: null
                });

                // Inicializar progreso
                await window.setDoc(window.doc(window.db, 'progress', user.uid), {
                    tables: {
                        2: { accuracy: 0, sessions: 0 },
                        3: { accuracy: 0, sessions: 0 },
                        4: { accuracy: 0, sessions: 0 },
                        5: { accuracy: 0, sessions: 0 },
                        6: { accuracy: 0, sessions: 0 },
                        7: { accuracy: 0, sessions: 0 },
                        8: { accuracy: 0, sessions: 0 },
                        9: { accuracy: 0, sessions: 0 },
                        10: { accuracy: 0, sessions: 0 },
                        11: { accuracy: 0, sessions: 0 },
                        12: { accuracy: 0, sessions: 0 },
                        13: { accuracy: 0, sessions: 0 }
                    },
                    totalSessions: 0,
                    lastUpdated: new Date().toISOString()
                });

                showMessage('¬°Cuenta creada exitosamente! Redirigiendo...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error registrando usuario:', error);
                let errorMessage = 'Error creando la cuenta. Intenta de nuevo.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email ya est√° registrado. Usa el Login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido. Verifica el formato.';
                }
                
                showMessage(errorMessage, 'error');
            }

            document.getElementById('register-btn').disabled = false;
            document.getElementById('register-btn').textContent = '‚ú® Crear Mi Aventura';
        }

        // Login usuario
        async function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }

            document.getElementById('login-btn').disabled = true;
            document.getElementById('login-btn').textContent = 'Entrando...';

            try {
                const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
                
                showMessage('¬°Bienvenido de vuelta! Redirigiendo...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);

            } catch (error) {
                console.error('Error en login:', error);
                let errorMessage = 'Error iniciando sesi√≥n. Verifica tus datos.';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado. ¬øNecesitas registrarte?';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta. Intenta de nuevo.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido. Verifica el formato.';
                }
                
                showMessage(errorMessage, 'error');
            }

            document.getElementById('login-btn').disabled = false;
            document.getElementById('login-btn').textContent = 'üöÄ Entrar a Mi Aventura';
        }

        // Volver al inicio
        function goToHome() {
            window.location.href = 'index.html';
        }

        // Hacer funciones globales
        window.showLogin = showLogin;
        window.showRegister = showRegister;
        window.registerUser = registerUser;
        window.loginUser = loginUser;
        window.goToHome = goToHome;
    </script>

</body>
</html>
