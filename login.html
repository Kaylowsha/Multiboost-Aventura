<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiBoost - Modo Aventura</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .google-btn {
            background: white;
            color: #757575;
            border: 1px solid #dadce0;
            transition: all 0.3s ease;
        }
        
        .google-btn:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="text-white">

    <!-- PANTALLA DE LOGIN/REGISTRO -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-3xl p-8 text-center max-w-md w-full">
            
            <!-- HEADER -->
            <h1 class="text-4xl font-bold mb-2">‚ö° MultiBoost ‚ö°</h1>
            <h2 class="text-2xl mb-2 text-yellow-300">üèÉ‚Äç‚ôÇÔ∏è MODO AVENTURA</h2>
            <p class="text-lg mb-8 opacity-90">Registra tu progreso y mejora d√≠a a d√≠a</p>

            <!-- M√âTODOS DE AUTENTICACI√ìN -->
            <div class="space-y-6">
                
                <!-- LOGIN CON GOOGLE (PRINCIPAL) -->
                <div class="space-y-4">
                    <h3 class="text-xl font-bold mb-4">üöÄ Acceso R√°pido</h3>
                    
                    <button onclick="loginWithGoogle()" id="google-login-btn" 
                            class="google-btn w-full py-4 px-6 rounded-2xl text-lg font-bold flex items-center justify-center space-x-3 hover:shadow-lg transition-all">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span>Continuar con Google</span>
                    </button>
                    
                    <p class="text-sm opacity-75">
                        ‚úÖ Sin contrase√±as ‚Ä¢ ‚úÖ Inicio r√°pido ‚Ä¢ ‚úÖ Totalmente seguro
                    </p>
                </div>

                <!-- SEPARADOR -->
                <div class="flex items-center my-6">
                    <div class="flex-1 border-t border-white border-opacity-30"></div>
                    <span class="px-4 text-sm opacity-60">o</span>
                    <div class="flex-1 border-t border-white border-opacity-30"></div>
                </div>

                <!-- REGISTRO MANUAL (SECUNDARIO) -->
                <div class="space-y-4">
                    <h3 class="text-lg font-bold mb-4">üìù Registro Manual</h3>
                    
                    <div id="manual-form" class="space-y-3">
                        <input type="text" id="manual-name" placeholder="Tu nombre completo" 
                               class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                        
                        <input type="email" id="manual-email" placeholder="Tu email" 
                               class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                        
                        <input type="password" id="manual-password" placeholder="Crear contrase√±a (min 6 caracteres)" 
                               class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                        
                        <button onclick="registerManually()" id="manual-register-btn"
                                class="w-full py-3 px-6 rounded-2xl text-lg font-bold text-white shadow-lg bg-gradient-to-r from-purple-400 to-pink-500 hover:from-purple-500 hover:to-pink-600">
                            ‚ú® Crear Cuenta Manual
                        </button>
                    </div>

                    <!-- LOGIN MANUAL -->
                    <div class="text-center mt-4">
                        <button onclick="showManualLogin()" id="show-login-btn" class="text-yellow-300 underline font-bold">
                            ¬øYa tienes cuenta manual? Inicia sesi√≥n
                        </button>
                    </div>

                    <!-- FORMULARIO LOGIN MANUAL (OCULTO) -->
                    <div id="manual-login-form" class="space-y-3" style="display: none;">
                        <input type="email" id="login-email" placeholder="Tu email" 
                               class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                        
                        <input type="password" id="login-password" placeholder="Tu contrase√±a" 
                               class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-90 text-black font-bold placeholder-gray-500">
                        
                        <button onclick="loginManually()" id="manual-login-btn"
                                class="w-full py-3 px-6 rounded-2xl text-lg font-bold text-white shadow-lg bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600">
                            üöÄ Entrar a Mi Aventura
                        </button>
                        
                        <button onclick="showManualRegister()" class="text-yellow-300 underline font-bold">
                            ‚Üê Volver al registro
                        </button>
                    </div>
                </div>
            </div>

            <!-- MENSAJES -->
            <div id="message" class="mt-4 p-3 rounded-lg" style="display: none;"></div>

            <!-- BOT√ìN VOLVER -->
            <button onclick="goToHome()" class="w-full mt-6 py-3 px-6 rounded-2xl text-lg font-bold text-white bg-white bg-opacity-20 hover:bg-opacity-30">
                üè† ‚Üê Volver al Inicio
            </button>

        </div>
    </div>

    <!-- FIREBASE SCRIPTS -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Hacer disponibles globalmente
        window.auth = auth;
        window.db = db;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        console.log('üî• Modo Aventura con Google Auth cargado');
    </script>

    <script>
        // === GOOGLE AUTH ===
        async function loginWithGoogle() {
            console.log('üöÄ Iniciando login con Google...');
            
            const googleBtn = document.getElementById('google-login-btn');
            googleBtn.disabled = true;
            googleBtn.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-600"></div>
                <span>Conectando con Google...</span>
            `;

            try {
                const provider = new window.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await window.signInWithPopup(window.auth, provider);
                const user = result.user;
                
                console.log('‚úÖ Login exitoso con Google:', user.uid);
                console.log('üìß Email:', user.email);
                console.log('üë§ Nombre:', user.displayName);
                
                // Verificar si ya existe el estudiante
                const studentDoc = await window.getDoc(window.doc(window.db, 'students', user.uid));
                
                if (!studentDoc.exists()) {
                    // Crear nuevo estudiante
                    await createStudentFromGoogle(user);
                } else {
                    console.log('‚úÖ Estudiante existente encontrado');
                }
                
                showMessage(`¬°Bienvenido ${user.displayName}! Redirigiendo...`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error con Google Auth:', error);
                
                let errorMessage = 'Error conectando con Google';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Login cancelado por el usuario';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Popup bloqueado. Permite popups e intenta de nuevo';
                }
                
                showMessage(errorMessage, 'error');
            }
            
            // Restaurar bot√≥n
            googleBtn.disabled = false;
            googleBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continuar con Google</span>
            `;
        }

        // Crear estudiante desde Google
        async function createStudentFromGoogle(user) {
            console.log('üìù Creando nuevo estudiante desde Google...');
            
            const studentCode = generateStudentCode();
            
            // Crear perfil en Firestore
            await window.setDoc(window.doc(window.db, 'students', user.uid), {
                name: user.displayName,
                email: user.email,
                studentCode: studentCode,
                createdAt: new Date().toISOString(),
                emailVerified: true, // Google ya verifica emails
                authMethod: 'google',
                photoURL: user.photoURL || null
            });

            // Inicializar progreso
            await window.setDoc(window.doc(window.db, 'progress', user.uid), {
                tables: {
                    2: { accuracy: 0, sessions: 0 },
                    3: { accuracy: 0, sessions: 0 },
                    4: { accuracy: 0, sessions: 0 },
                    5: { accuracy: 0, sessions: 0 },
                    6: { accuracy: 0, sessions: 0 },
                    7: { accuracy: 0, sessions: 0 },
                    8: { accuracy: 0, sessions: 0 },
                    9: { accuracy: 0, sessions: 0 },
                    10: { accuracy: 0, sessions: 0 },
                    11: { accuracy: 0, sessions: 0 },
                    12: { accuracy: 0, sessions: 0 },
                    13: { accuracy: 0, sessions: 0 }
                },
                totalSessions: 0,
                lastUpdated: new Date().toISOString()
            });
            
            console.log(`‚úÖ Estudiante creado: ${user.displayName} (${studentCode})`);
        }

        // === REGISTRO MANUAL ===
        async function registerManually() {
            const name = document.getElementById('manual-name').value.trim();
            const email = document.getElementById('manual-email').value.trim();
            const password = document.getElementById('manual-password').value;

            if (!name || !email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            document.getElementById('manual-register-btn').disabled = true;
            document.getElementById('manual-register-btn').textContent = 'Creando cuenta...';

            try {
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                const studentCode = generateStudentCode();

                await window.setDoc(window.doc(window.db, 'students', user.uid), {
                    name: name,
                    email: email,
                    studentCode: studentCode,
                    createdAt: new Date().toISOString(),
                    emailVerified: true, // Sin verificaci√≥n por ahora
                    authMethod: 'manual'
                });

                await window.setDoc(window.doc(window.db, 'progress', user.uid), {
                    tables: {
                        2: { accuracy: 0, sessions: 0 },
                        3: { accuracy: 0, sessions: 0 },
                        4: { accuracy: 0, sessions: 0 },
                        5: { accuracy: 0, sessions: 0 },
                        6: { accuracy: 0, sessions: 0 },
                        7: { accuracy: 0, sessions: 0 },
                        8: { accuracy: 0, sessions: 0 },
                        9: { accuracy: 0, sessions: 0 },
                        10: { accuracy: 0, sessions: 0 },
                        11: { accuracy: 0, sessions: 0 },
                        12: { accuracy: 0, sessions: 0 },
                        13: { accuracy: 0, sessions: 0 }
                    },
                    totalSessions: 0,
                    lastUpdated: new Date().toISOString()
                });

                showMessage(`¬°Bienvenido ${name}! Tu c√≥digo es: ${studentCode}. Redirigiendo...`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error registrando manualmente:', error);
                let errorMessage = 'Error creando la cuenta';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email ya est√° registrado';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido';
                }
                
                showMessage(errorMessage, 'error');
            }

            document.getElementById('manual-register-btn').disabled = false;
            document.getElementById('manual-register-btn').textContent = '‚ú® Crear Cuenta Manual';
        }

        // === LOGIN MANUAL ===
        async function loginManually() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }

            document.getElementById('manual-login-btn').disabled = true;
            document.getElementById('manual-login-btn').textContent = 'Entrando...';

            try {
                const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                showMessage('¬°Bienvenido de vuelta! Redirigiendo...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);

            } catch (error) {
                console.error('Error en login manual:', error);
                let errorMessage = 'Error iniciando sesi√≥n';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta';
                }
                
                showMessage(errorMessage, 'error');
            }

            document.getElementById('manual-login-btn').disabled = false;
            document.getElementById('manual-login-btn').textContent = 'üöÄ Entrar a Mi Aventura';
        }

        // === NAVEGACI√ìN ENTRE FORMULARIOS ===
        function showManualLogin() {
            document.getElementById('manual-form').style.display = 'none';
            document.getElementById('show-login-btn').style.display = 'none';
            document.getElementById('manual-login-form').style.display = 'block';
        }

        function showManualRegister() {
            document.getElementById('manual-form').style.display = 'block';
            document.getElementById('show-login-btn').style.display = 'block';
            document.getElementById('manual-login-form').style.display = 'none';
        }

        // === UTILIDADES ===
        function generateStudentCode() {
            const prefix = 'EST_';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = prefix;
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (type === 'success') {
                messageEl.className = 'mt-4 p-3 rounded-lg bg-green-500 bg-opacity-80 text-white font-bold';
            } else {
                messageEl.className = 'mt-4 p-3 rounded-lg bg-red-500 bg-opacity-80 text-white font-bold';
            }
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        // Hacer funciones globales
        window.loginWithGoogle = loginWithGoogle;
        window.registerManually = registerManually;
        window.loginManually = loginManually;
        window.showManualLogin = showManualLogin;
        window.showManualRegister = showManualRegister;
        window.goToHome = goToHome;

        console.log('‚úÖ Login con Google Auth completamente cargado');
    </script>
</body>
</html>
